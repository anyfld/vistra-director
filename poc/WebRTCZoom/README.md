# WebRTC Camera Zoom Viewer

go2rtcの映像をズーム制御できるWebビューアです。

**配信側（スマホ）でカメラのズームを制御**し、受信側（PC）で視聴できます。

## 構成

```
┌─────────────────┐                           ┌─────────────────┐
│  配信側（iPhone）│──────┐             ┌─────│  視聴側（PC）   │
│  broadcast.html │      │  WebRTC    │      │   index.html    │
│  ★ズーム制御    │      ▼  直接接続   ▼      │   表示ズーム    │
└─────────────────┘   ┌─────────────┐        └─────────────────┘
                      │   go2rtc    │                │
                      │   サーバー   │                │
                      └─────────────┘                │
                                                     │ ズーム指示
┌─────────────────────────────────────────────────────┘
│  WebRTCZoom サーバー
│  - UI配信（HTML/JS）
│  - ズーム/PTZ制御の中継
└─────────────────────────────────────────────────────
```

**ポイント**: WebRTC映像ストリームはブラウザからgo2rtcに直接接続します。WebRTCZoomサーバーはUI配信とズーム制御の中継のみを担当します。

## 機能

### 配信側（broadcast.html）
- 📹 **カメラ配信**: go2rtcへWebRTC配信
- 🔍 **カメラズーム**: Media Capture APIでiPhoneカメラのズームを制御
- 🔄 **カメラ切替**: 内カメラ/外カメラの切替

### 視聴側（index.html）
- 📺 **映像視聴**: go2rtcからWebRTC受信
- 🔎 **表示ズーム**: ブラウザ上でのデジタルズーム
- ↔️ **パン**: 表示位置の移動

## 使用方法

### 前提条件

- go2rtcサーバーがHTTPSで稼働していること（`https://localhost:443`）
- go2rtcの設定でCORSが許可されていること（`api.origin: "*"`）

### 1. go2rtc の設定

`go2rtc.yaml` に以下を設定：

```yaml
api:
  origin: "*"
  listen: ":1984"
  tls_listen: ":443"
  tls_cert: /path/to/cert.pem
  tls_key: /path/to/key.pem
```

### 2. サーバーを起動

```bash
cd poc
uv run python WebRTCZoom/main.py --insecure
```

> **Note**: `--insecure` オプションは自己署名証明書を使う場合に必要です。

### 3. 配信側（スマホ）の設定

1. スマホのブラウザで以下にアクセス：
   ```
   https://<PCのIPアドレス>:8443/broadcast.html
   ```
2. 自己署名証明書の警告が出たら「詳細」→「このサイトにアクセス」
3. カメラへのアクセスを許可
4. 「配信開始」ボタンをタップ
5. **ズームスライダーでカメラのズームを調整**

### 4. 視聴側（PC）の設定

1. ブラウザで `https://localhost:8443/` にアクセス
2. ストリーム名を入力して「接続」
3. 映像が表示される

## コマンドラインオプション

```bash
uv run python WebRTCZoom/main.py --help
```

| オプション | 説明 | デフォルト |
|-----------|------|----------|
| `--port PORT` | サーバーポート番号 | 8443 |
| `--url URL` | go2rtcサーバーURL | https://localhost |
| `--insecure` | SSL検証をスキップ（自己署名証明書用） | - |
| `--http` | HTTPモード（ローカル開発用） | - |
| `--no-browser` | ブラウザを自動で開かない | - |

## ⚠️ 注意事項

### カメラズームのサポート

- **iOS Safari**: ズームがサポートされている（iOS 16以降推奨）
- **iOS Chrome**: WebKitベースのため、Safariと同様
- **Android Chrome**: 機種によりサポート状況が異なる

ズームがサポートされていない場合、配信ページに警告が表示されます。

### HTTP/HTTPS について

**HTTPSモード（推奨）:**
- カメラアクセスにはHTTPSが必要（localhost以外）
- go2rtcもHTTPS化することでMixed Content問題を回避
- 自己署名証明書の場合、ブラウザで警告を許可する必要あり

**HTTPモード（ローカル開発用）:**
- `--http` オプションで起動
- localhostからのみカメラアクセス可能
- スマホなど外部デバイスからはカメラが使えません

## トラブルシューティング

### カメラにアクセスできない

- ブラウザの設定でカメラへのアクセスを許可してください
- HTTPSでアクセスしていることを確認してください

### ズームが動作しない

- 「このカメラはズームをサポートしていません」と表示される場合、ブラウザまたはOSがカメラズーム制御に対応していません
- Safari（iOS）を使用することをお勧めします

### 配信が開始できない

- go2rtcサーバーが起動していることを確認
- サーバーURLが正しいことを確認
- ネットワーク接続を確認

## 技術詳細

### 使用API

- **MediaDevices.getUserMedia()**: カメラアクセス
- **MediaStreamTrack.applyConstraints()**: ズーム制御
- **WebRTC (WHIP/WHEP)**: go2rtcとの通信
- **CSS Transform**: 表示ズーム

### 対応ブラウザ

| ブラウザ | 配信 | 視聴 | ズーム |
|---------|------|------|--------|
| Safari (iOS) | ✅ | ✅ | ✅ (iOS 16+) |
| Chrome (iOS) | ✅ | ✅ | ✅ |
| Chrome (PC) | ✅ | ✅ | △ (外部カメラ依存) |
| Firefox | ✅ | ✅ | ❌ |

## ライセンス

MIT License

